using Content.Shared.Theta.ShipEvent.UI;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Theta.ShipEvent.UI;

[GenerateTypedNameReferences]
public sealed partial class TeamLobbyWindow : DefaultWindow
{
    public event Action<BaseButton.ButtonEventArgs>? CreateTeamButtonPressed;
    public event Action<BaseButton.ButtonEventArgs>? RefreshButtonPressed;
    public event Action<string, bool>? JoinButtonPressed;

    public TeamLobbyWindow()
    {
        RobustXamlLoader.Load(this);
        CreateTeam.OnPressed += _ => CreateTeamButtonPressed?.Invoke(_);
        Refresh.OnPressed += _ => RefreshButtonPressed?.Invoke(_);
    }

    public void UpdateState(ShipEventLobbyBoundUserInterfaceState msg)
    {
        TeamsContainer.RemoveAllChildren();
        if (msg.Teams.Count == 0)
        {
            TeamsContainer.AddChild(new Label
            {
                Text = Loc.GetString("shipevent-lobby-empty")
            });
            return;
        }

        TeamsContainer.AddChild(new Label
        {
            Text = Loc.GetString("shipevent-lobby-team"),
        });

        TeamsContainer.AddChild(new Label
        {
            Text = Loc.GetString("shipevent-lobby-captain"),
        });

        TeamsContainer.AddChild(new Label
        {
            Text = Loc.GetString("shipevent-lobby-crew"),
            HorizontalAlignment = HAlignment.Right,
        });

        TeamsContainer.AddChild(new Label
        {
            Text = Loc.GetString("shipevent-lobby-password"),
            HorizontalAlignment = HAlignment.Right,
        });

        TeamsContainer.AddChild(new Control());

        foreach (var teamState in msg.Teams)
        {
            TeamsContainer.AddChild(new Label
            {
                Text = teamState.Name,
            });

            TeamsContainer.AddChild(new Label
            {
                Text = teamState.Captain,
            });

            var maximumPlayersStr = teamState.MaxMembers == 0 ? "∞" : teamState.MaxMembers.ToString();
            TeamsContainer.AddChild(new Label
            {
                Text = $"{teamState.Members}/{maximumPlayersStr}",
                HorizontalAlignment = HAlignment.Right,
            });

            TeamsContainer.AddChild(new Label
            {
                Text = teamState.HasPassword ? "*****" : "",
                HorizontalAlignment = HAlignment.Right,
            });

            var button = new Button
            {
                Text = Loc.GetString("shipevent-lobby-join"),
            };

            button.OnPressed += _ =>
            {
                JoinButtonPressed?.Invoke(teamState.Name, teamState.HasPassword);
            };

            TeamsContainer.AddChild(button);
        }
    }
}
